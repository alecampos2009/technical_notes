\documentclass[11pt]{article}

\usepackage{"../../info/packages"}
\usepackage{"../../info/nomenclature"}
\usepackage{fullpage}
\usepackage{booktabs}
\usepackage{array}
\usepackage{cellspace}
\newcommand{\uhat}{\hat{u}}
\newcommand{\xhat}{\hat{x}}

\title{Curvilinear coordinates}


\begin{document}

\maketitle

\section{Basic definitions}
\subsection{Cartesian coordinates}
Consider Euclidean space, which is represented by cartesian coordinates. We denote the coordinates as $(x^1,x^2,x^3)$ and the basis unit vectors as $\xvec_1, \xvec_2, \xvec_2$. The position vector is $\xvec = x^1 \xvec_1 + x^2 \xvec_2 + x^3 \xvec_3$. 

Notice that the components were denoted with upper scripts and the unit vectors with lower scripts. For cartesian coordinates it doesn't matter if we use upper or lower scripts, that is, $x^i = x_i$ and $\xvec_i=\xvec^i$. For other coordinate systems, as we'll see in the sections below, upper scripts and lower scripts have different meanings.

\subsection{Curvilinear Coordinates}
We will now define a new coordinate system, a curvilinear coordinate system, in relation to the standard cartesian coordinates. The coordinates of this curvilinear system are denoted as $(u^1, u^2, u^3)$. We introduce the following two sets of functions
\begin{align}
\uhat^i &= \uhat^i(x^1, x^2, x^3), \\
\xhat^i &= \xhat^i(u^1,u^2,u^3),
\end{align}
such that they satisfy
\begin{align}
    \xhat^i(\uhat^1, \uhat^2, \uhat^3) &= x^i \label{eq:trans1}\\
    \uhat^i(\xhat^1, \xhat^2, \xhat^3) &= u^i \label{eq:trans2},
\end{align}
for $i=1,2,3$. In other words, $\hat{u}^i$ and $\hat{x}^i$ are functions that map between coordinates in the cartesian and curvilinear systems. 

We can now take the derivative of either \cref{eq:trans1} or \cref{eq:trans2}. For example, the derivative $d/du^j$ of \cref{eq:trans2} gives
\begin{equation}
    \left ( \frac{\partial \uhat^i}{\partial x^k} \right)_{x^i = \xhat^i} \frac{\partial \xhat^k}{\partial u^j} = \delta^i_j.
\end{equation}
We can evaluate the above at $u^i = \hat{u}^i$, so that
\begin{equation}
     \frac{\partial \uhat^i}{\partial x^k} \left( \frac{\partial \xhat^k}{\partial u^j} \right)_{u^i = \hat{u}^i} = \delta^i_j.
\end{equation}
We now define two basis vectors as follows
\begin{equation}
\label{eq:basis_sub}
    \evec_i = \left ( \frac{ \partial \xhat^1}{\partial u^i} \right)_{u^i = \hat{u}^i} \xvec_1 + \left ( \frac{ \partial \xhat^2}{\partial u^i} \right)_{u^i = \hat{u}^i} \xvec_2 + \left ( \frac{ \partial \xhat^3}{\partial u^i} \right)_{u^i = \hat{u}^i} \xvec_3
\end{equation}
\begin{equation}
\label{eq:basis_sup}
    \evec^i = \frac{ \partial \uhat^i}{\partial x^1} \xvec^1 + \frac{ \partial \uhat^i}{\partial x^2} \xvec^2 + \frac{ \partial \uhat^i}{\partial x^3}. \xvec^3
\end{equation}
The dot product of these two vectors is given by
\begin{equation}
\label{eq:basis_orthogonality}
    \evec^i \cdot \evec_j = \delta^i_j.
\end{equation}
The two coordinate bases are not necessarily constant, orthogonal, of unit length, or dimensionless.

\textbf{At the end, one way to think about it is that for every point $[x^1,x^2,x^3]$ in the cartesian coordinate system, there is a corresponding coordinate given by $[\uhat^1,\uhat^2,\uhat^3]$, and that at every point of these new coordinates, there are two coordinate bases, given by \cref{eq:basis_sub} and \cref{eq:basis_sup}.} The latter basis is typically expresses as $\nabla \uhat^1$,$\nabla \uhat^2$, and $\nabla \uhat^3$.

\subsection{Vectors}
Since there are two coordinate bases, one can define two types of vectors at every point in the domain. One is a vector in terms of contravariant components $v^i$ 
\begin{equation}
    \vvec = v^1 \evec_1 + v^2 \evec_2 + v^3 \evec_3,
\end{equation}
and the other a vector in terms of covariant components $v_i$
\begin{equation}
    \vvec = v_1 \evec^1 + v_2 \evec^2 + v_3 \evec^3.
\end{equation}
Note that, due to \cref{eq:basis_orthogonality}, we have $v^i = \vvec \cdot \evec^i$ and $v_i = \vvec \cdot \evec_i$.

We now define the metric coefficients $g_{ij}$ and $g^{ij}$ as
\begin{align}
    g_{ij} &= \evec_i \cdot \evec_j \\
    g^{ij} &= \evec^i \cdot \evec^j \\
\end{align}
Thus, the dot product of two vectors in the curvilinear reference frame simplifies to the following
\begin{equation}
\vvec \cdot \wvec = v^i w_i = v_i w^i = g_{ij} v^i w^j = g^{ij} v_i w_j.
\end{equation}
The cross product can be computed as
\begin{align}
    \vvec \times \wvec &= \epsilon_{ijk} \sqrt{g} v^i w^j \evec^k \\
    \vvec \times \wvec &= \epsilon^{ijk} \frac{1}{\sqrt{g}} v_i w_j \evec_k,
\end{align}
where $g = \text{det}(g_{ij})$. One can also define $g^{-1} = \text{det}(g^{ij})$.

\section{Calculus}
\subsection{Integration}
\begin{itemize}

\item Volume integrals: Define $d V_u$ as an infinitesimal volume in curvilinear coordinates, $\Omega_u$ as a finite volume of integration in curvilinear coordinates, and $f_u$ as a function whose input is in curvilinear coordinates, that is, $f_u = f_u(u^1,u^2,u^3)$. Then, the volume integral can be computed using
\begin{equation}
\label{eq:vol_int}
    \int_{\Omega_u} f_u \, d V_u = \int_{\Omega_u} f_u \, |\text{det}(J_{ij})| du^1 du^2 du^3,
\end{equation}
where $J_{ij} = \partial \hat{x}^i / \partial u^j$ is the Jacobian. Given that Eulerian coordinates can be thought of as an instance of curvilinear coordinates, we have
\begin{equation}
\label{eq:vol_int_eulerian}
    \int_{\Omega_u} f_u \, dV_u =  \int_{\Omega_x} f_x \, dV_x = \int_{\Omega_x} f_x \, dx^1 dx^2 dx^3 
\end{equation}
One thing to note is that $f_x(x^1,x^2,x^3)$ and $f_u(u^1,u^2,u^3)$ are equal when evaluated at the same point in space.
In other words, these functions satisfy
\begin{equation}
    f_u(u^1,u^2,u^3) = f_x(\hat{x}^1, \hat{x}^2, \hat{x}^3).
\end{equation}
Equating \cref{eq:vol_int,eq:vol_int_eulerian} allows us to write the standard rule for integration by substitution
\begin{equation}
    \int_{\Omega_x} f_x(x^1,x^2,x^3) \, dx^1 dx^2 dx^3 = \int_{\Omega_u} f_x(\hat{x}^1, \hat{x}^2, \hat{x}^3) \, |\text{det}(J_{ij})| du^1 du^2 du^3 .
\end{equation}

\item Surface integrals: Define $d S_u$ as an infinitesimal surface in curvilinear coordinates, $\Gamma_u$ as a finite surface of integration in curvilinear coordinates that belongs to the $u^1 = \text{constant}$ surfaces, and $f_u$ as a function whose input is defined using curvilinear coordinates. Then, a surface integral can be computed using 
\begin{equation}
    \int_{\Gamma_u} f_u\, d S_u = \int_{\Gamma_u} f_u \, J | \nabla \hat{u}^1| du^2 du^3.
\end{equation}
Note that now we can write
\begin{multline}
\label{eq:int_from_vol_surf}
    \int_{\Omega_u} f_u \,dV_u = \int_{u^1_l}^{u^1_u} \int_{\Gamma_u} f_u \, J du^1 du^2 du^3 = \\ 
    \int_{u^1_l}^{u^1_u} \int_{\Gamma_u} f_u \, \frac{J | \nabla \hat{u}^1| du^2 du^3}{| \nabla \hat{u}^1 |} du^1 = \int_{u^1_l}^{u^1_u} \int_{\Gamma_u} f_u \, \frac{dS_u}{|\nabla \hat{u}^1|} du^1.
\end{multline}

\end{itemize}

\subsection{Differentiation}
\subsubsection{The grad operator}
Consider the function $f_x = f_x(x^1, x^2, x^3)$ and the grad operator, which is  
\begin{equation}
    \nabla f_x = \frac{\partial f_x}{\partial x^1} \xvec_1 + \frac{\partial f_x}{\partial x^2} \xvec_2 + \frac{\partial f_x}{\partial x^3} \xvec_3.
\end{equation}
We now introduce the function $f_u = f_u(u^1,u^2,u^3)$ and note that $f_x = f_u(\uhat^1,\uhat^2,\uhat^3)$. Thus
\begin{equation}
    \frac{\partial f_x}{\partial x^1} = \left ( \frac{ \partial f_u}{\partial u^1} \right)_{\uvec = \hat{\uvec}}        \frac{\partial \uhat^1}{\partial x^1} + 
                     \left ( \frac{ \partial f_u}{\partial u^2} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^2}{\partial x^1} +
                     \left ( \frac{ \partial f_u}{\partial u^3} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^3}{\partial x^1}, 
\end{equation}
\begin{equation}
    \frac{\partial f_x}{\partial x^2} = \left ( \frac{ \partial f_u}{\partial u^1} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^1}{\partial x^2} + 
                     \left ( \frac{ \partial f_u}{\partial u^2} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^2}{\partial x^2} +
                     \left ( \frac{ \partial f_u}{\partial u^3} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^3}{\partial x^2},
\end{equation}
\begin{equation}
    \frac{\partial f_x}{\partial x^3} = \left ( \frac{ \partial f_u}{\partial u^1} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^1}{\partial x^3} + 
                     \left ( \frac{ \partial f_u}{\partial u^2} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^2}{\partial x^3} +
                     \left ( \frac{ \partial f_u}{\partial u^3} \right)_{\uvec = \hat{\uvec}} \frac{\partial \uhat^3}{\partial x^3} .
\end{equation}
Using the definition of $\evec^i$, the grad operator can be written as
\begin{equation}
    \nabla f_x = \left ( \frac{\partial f_u }{\partial u^1} \right )_{\uvec = \hat{\uvec}} \evec^1 + \left ( \frac{\partial f_u }{\partial u^2} \right )_{\uvec = \hat{\uvec}} \evec^2 + \left ( \frac{\partial f_u }{\partial u^3} \right )_{\uvec = \hat{\uvec}} \evec^3 .
\end{equation}
This shows the equivalence between the grad operator in Eulerian coordinates and curvilinear coordinates.

\subsubsection{The divergence operator}

\subsubsection{The curl operator}
The curl is given by
\begin{equation}
    \nabla \times A = \epsilon^{ijk} \frac{1}{\sqrt{g}} \frac{\partial A_j}{\partial u^i} \evec_k
\end{equation}

\section{Flux coordinates}
Imagine that Euclidean space is permeated by a set of surfaces, which we call flux surfaces. Each of those surfaces is labeled with a different value of the variable $\psi$. We also note that the flux surfaces are not stationary, they can move around as time progresses.

We now introduce the function $\hat{\psi} = \hat{\psi}(t,x^1,x^2,x^3)$. This function is defined in such a way that for all values $x^1,x^2,x^3$ that are part of a given flux surface at a specific time $t$, then $\hat{\psi}$ will evaluate to the value of $\psi$ corresponding to that flux surface. The velocity of the flux surfaces is given by $\Vvec_\psi = \Vvec_\psi(t,x^1,x^2,x^3)$. Thus, by definition
\begin{equation}
\label{eq:cons_flux_surf}
    \frac{\partial \hat{\psi}}{\partial t} + \Vvec_\psi \cdot \nabla \hat{\psi} = 0.
\end{equation}

A flux coordinate is defined as one in which $\hat{u}^1 = \hat{\psi}$.


\subsection{Flux-surface averaging}
To begin, we define the following. $D(\psi,t)$ is the volume enclosed at time t by the flux surface labelled by $\psi$. The surface of $D(\psi,t)$ is labelled as $\partial D(\psi,t)$. Additionally, $\Delta(\psi,t) = D(\psi + \Delta \psi,t) - D(\psi,t)$.

The flux surface average of a function is given by
\begin{equation}
\label{eq:flux_surf_avg_1}
    \langle f \rangle_\psi = \lim_{\Delta \psi \to 0} \frac{ \int_{\Delta(\psi,t)} f \, d V}{\int_{\Delta(\psi,t)} d V}.
\end{equation}
This can be re-written as shown below
\begin{equation}
    \langle f \rangle_\psi = \lim_{\Delta \psi \to 0} \frac{ \frac{1}{\Delta \psi} \int_{\Delta(\psi,t)} f \, d V}{ \frac{1}{\Delta(\psi)} \int_{\Delta(\psi,t)} d V} = \lim_{\Delta \psi \to 0} \frac{ \frac{1}{\Delta \psi} \left ( \int_{D(\psi + \Delta \psi,t)} f\, d V - \int_{D(\psi,t)} f\, d V \right)}{ \frac{1}{\Delta \psi} \left (\int_{D(\psi + \Delta \psi,t)} d V - \int_{D(\psi,t)} d V \right )} = \frac{ \frac{\partial}{\partial \psi} \int_{D(\psi,t)} f \, d V}{ \frac{\partial}{\partial \psi} \int_{D(\psi,t)} d V} .
\end{equation}
Defining $V' = V'(\psi,t)$ as 
\begin{equation}
    V' = \frac{\partial}{\partial \psi} \int_{D(\psi,t)} \, dV.
\end{equation}
the second expression for the flux surface average is written as
\begin{equation}
\label{eq:flux_surf_avg_2}
    \langle f \rangle_\psi = \frac{1}{V'} \frac{\partial}{\partial \psi} \int_{D(\psi,t)} f \, d V .
\end{equation}
A third expression for $\langle g \rangle_\psi$ follows from using \cref{eq:int_from_vol_surf} for the above. Thus,
\begin{equation}
\label{eq:flux_surf_avg_3}
    \langle f \rangle_\psi = \frac{1}{V'} \frac{\partial}{\partial \psi} \int_0^\psi \int_{\partial D(\psi',t)} f \, \frac{d S}{| \nabla \hat{\psi} |} d\psi' = \frac{1}{V'}  \int_{\partial D(\psi,t)} f \, \frac{d S}{| \nabla \hat{\psi} |} .
\end{equation}

\subsubsection{Average of spatial derivatives}
We use the second definition of the flux-surface average, given by \cref{eq:flux_surf_avg_2}, and then the divergence theorem to obtain
\begin{equation}
    \langle \nabla \cdot \Avec \rangle_\psi = \frac{1}{V'} \frac{\partial}{\partial \psi} \int_{D(\psi,t)} \nabla \cdot \Avec \,dV = \frac{1}{V'} \frac{\partial}{\partial \psi} \int_{\partial D(\psi,t)} \Avec \cdot  \frac{\nabla \hat{\psi}}{|\nabla \hat{\psi}|} \, dS.
\end{equation}
We now use the third definition \cref{eq:flux_surf_avg_3} to obtain
\begin{equation}
    \langle \nabla \cdot \Avec \rangle_\psi = \frac{1}{V'} \frac{\partial}{\partial \psi} V' \langle \Avec \cdot \nabla \hat{\psi} \rangle_\psi.
\end{equation}

\subsubsection{Average of time derivatives}
Using the Reynolds transport theorem we show
\begin{align}
    \frac{\partial}{\partial t} \int_{D(\psi,t)} f \,dV &= \int_{D(\psi,t)} \frac{\partial f}{\partial t} \, dV + \int_{\partial D(\psi,t)} f \Vvec_\psi \cdot \frac{\nabla \hat{\psi}}{|\nabla \hat{\psi}|} \,dS \nonumber \\
    &= \int_{D(\psi,t)} \frac{\partial f}{\partial t} \, dV + V' \langle f \Vvec_\psi \cdot \nabla \hat{\psi} \rangle_\psi.
\end{align}
We now take the derivative of both sides by $\psi$ and then divide by $V'$.
\begin{equation}
    \frac{1}{V'} \frac{\partial}{\partial t} V' \langle f \rangle_\psi = \left < \frac{\partial f}{\partial t} \right>_\psi + \frac{1}{V'} \frac{\partial}{\partial \psi} V' \langle f \Vvec_\psi \cdot \nabla \hat{\psi} \rangle_\psi.
\end{equation}
Re-arranging and using \cref{eq:cons_flux_surf}
\begin{equation}
    \left < \frac{\partial f}{\partial t} \right >_\psi = \frac{1}{V'} \frac{\partial}{\partial t} V' \langle f \rangle_\psi + \frac{1}{V'} \frac{\partial}{\partial \psi} V' \left < f \frac{\partial \hat{\psi}}{\partial t} \right >_\psi.
\end{equation}

\end{document}